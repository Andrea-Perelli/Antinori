@model Antinori.Models.AspNetUsers
@{
    ViewBag.Title = "Password dimenticata";
    Layout = "~/Views/Shared/_LayoutPublic.cshtml";
}

<div class="login-box">
    <div class="login-logo">

        <!-- logo for regular state and mobile devices -->
        <span class="logo-lg"><b>Antinori</b>Book</span>

    </div>
    <!-- /.login-logo -->
    <div class="login-box-body">
        <h3>La tua password è scaduta e deve essere sostituita!</h3>
        @using (Html.BeginForm("ChangePassword", "Account", FormMethod.Post, new { id = "CONTENT_ChangePassword_Form" }))
        {
            <!-- we can set an action with this attribute: we set that the authentication token has to be the same between requests. -->
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true)
            @Html.HiddenFor(p => p.Id)
            <div>
                <div class="row">
                    <div class="col-md-12">
                        <small class="required">Vecchia Password</small><br />
                        @Html.PasswordFor(m => m.Password, new { @class = "form-control", required = "required", id = "pass1" })
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col-md-12">
                        <small class="required">Nuova Password</small><br />
                        @Html.PasswordFor(m => m.ConfirmPassword, new { @class = "form-control", required = "required", id = "pass2" })
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col-md-12">
                        <small class="required">Conferma Password</small><br />
                        @Html.PasswordFor(m => m.NewPassword, new { @class = "form-control", required = "required", id = "pass3" })
                    </div>
                </div>
                <!-- ERROR MESSAGES -->
                <div class="nosamepass" hidden style="color: red!important; font-weight: bold; margin-left: 10px">Le password non corrispondono!</div>
                <div class="smallpass" hidden style="color: red!important; font-weight: bold; margin-left: 10px">Password troppo corta!</div>
            </div>
        }
            <div class="box-footer">
                <div class="pull-right">
                    <button class="btn btn-primary" onclick="ChangePassword()">Cambia password</button>
                    &nbsp;&nbsp;
                    <a class="btn btn-primary" href="@Url.Action("Login","Account")">Torna al login</a>
                </div>
            </div>

        </div>
    <!-- /.login-box-body -->
</div>

@section scripts {
    <script>
    function ChangePassword(Password, NewPassword) {
        $('#CONTENT_ChangePassword_Form').validate({
            lang: 'it'
        });

        if ($('#CONTENT_ChangePassword_Form').valid()) {

            // hide things.
            $(".smallpass").fadeOut('slow');
            $(".nosamepass").fadeOut('slow');

            // if it is not small
            if ($("#pass2").val().length >= 6) {
                // if are not equal.
                if ($("#pass2").val() != $("#pass3").val()) {
                    $(".nosamepass").fadeIn('slow');
                    // exit.
                    return false;
                    }
                    else {
                        // hide nosamepass
                        $(".nosamepass").fadeOut('slow');
                    }
                }
                else { // small password.
                    $(".smallpass").fadeIn('slow');
                    // exit.
                    return false;
                }

            // show the refresher.
            REFRESH_show("MODAL_Refresh");
            var url = '@Url.Action("ChangePassword", "Account")';
            // take the form content by id.
            var data = new FormData($('#CONTENT_ChangePassword_Form').get(0));

            $.ajax({
                type: "POST",
                url: url,
                data: data,
                contentType: false,
                processData: false,
                success: function (risultato) {

                    $("#MODAL_ID").modal('toggle');
                        if (!risultato.riuscita) {
                            // set error.
                            DANGER_function("Si è verificato un errore durante l'operazione", risultato.msg,"","","","OK");
                        }
                        else {
                            //if all was ok
                            SUCCESS_function("La password è stata modificata con successo.", "Complimenti!  L'operazione di cambio password si è conclusa con successo!", "vai('@Url.Action("Index","Home")')", "OK");
                        }
                    },
                    error: function () {
                        // set error.
                        DANGER_function("Si è verificato un errore durante l'operazione", "Controllare i dati inseriti e riprovare","","","","OK");
                    }
            });

        }
    }
    </script>
}
